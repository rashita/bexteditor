# 作業記録 2025-07-07

## 目的

テキストエディタにおいて、ファイルが編集されてから保存されていない「未保存」の状態を、ユーザーが視覚的に識別できるようにする。具体的には、ウィンドウのタイトルの先頭にアスタリスク（*）などのマークを表示し、保存が完了したらマークを消す機能を実装する。

## 課題と設計

### 1. 変更検知のタイミング

- **課題**: どのタイミングで「未保存」と判断するか。
- **採用した方式**: **ダーティフラグ（Dirty Flag）方式**
  - ファイルを開いた直後や保存直後は「クリーン（`isDirty = false`）」な状態とする。
  - エディタの内容に最初の変更が加えられた瞬間（`input`イベントを検知）に「ダーティ（`isDirty = true`）」状態に移行する。
  - この方式は、変更のたびに内容全体を比較するdiff方式よりもパフォーマンスに優れ、ユーザーにとっても直感的で分かりやすいという利点がある。

### 2. 複数ウィンドウへの対応

- **課題**: 複数のウィンドウを開いた際に、各ウィンドウの状態（どのファイルを開いているか、未保存か）が互いに干渉しないようにする。
- **採用した方式**: **レンダラープロセスによる状態管理**
  - ファイルの状態（`currentFilePath`, `isDirty`）を、アプリケーション全体で一つしかないメインプロセス（`main.js`）ではなく、各ウィンドウが持つ独立したレンダラープロセス（`renderer.js`）内で管理する。
  - これにより、各ウィンドウが自身の状態を完全に独立して保持できるため、複数ウィンドウでも問題なく動作する。

## 実装の概要

以下の3つのファイルを修正し、プロセス間通信（IPC）を用いて機能を実装した。

1.  **`renderer.js` (レンダラープロセス)**
    - ウィンドウ固有の状態として `currentFilePath` と `isDirty` 変数を管理。
    - エディタへの `input` イベントを監視し、変更があれば `isDirty` を `true` に設定。
    - ファイルのオープン/セーブが完了したら `isDirty` を `false` に設定。
    - 状態が変化するたびに、`ipcRenderer` を介してメインプロセスにタイトル更新を依頼する (`update-title` イベントを送信)。

2.  **`preload.js`**
    - `renderer.js` と `main.js` の安全な橋渡し役として、`update-title` の通信チャネルをコンテキストブリッジに公開。

3.  **`main.js` (メインプロセス)**
    - `ipcMain` で `update-title` イベントを待ち受けるリスナーを設置。
    - イベントを受け取ると、通知元のウィンドウ (`event.sender`) を特定し、そのウィンドウのタイトルを、受け取ったファイルパスと `isDirty` の状態に基づいて動的に更新する（例: `*filename.md`, `filename.md`）。

## ペースト処理の改善

### 課題

- エディタに複数行のテキストをペーストすると、`<div class="line">` がネストしたHTML構造（`<div class="line"><div class="line">...</div></div>`）が生成されてしまう。
- この結果、ファイルを保存する際に、ネストした親子両方の `div` からテキストが抽出され、内容が二重に保存される問題が発生していた。

### 解決策

- `renderer.js` に、ペーストイベント (`paste`) を専門に処理するイベントリスナーを新たに追加。
- デフォルトのペースト動作をキャンセルし、クリップボードの内容をDOMを直接操作して挿入するロジックを実装。

### 実装の詳細

1.  `e.preventDefault()` を呼び出し、ブラウザの標準ペースト機能を無効化。
2.  クリップボードからテキストを取得し、改行コードで複数行に分割。
3.  `window.getSelection()` と `range` を使用して、現在のカーソル位置や選択範囲を正確に特定。
4.  まず、選択範囲の既存のテキストを `range.deleteContents()` で削除。
5.  現在の行のカーソル位置より前のテキストと、ペーストされるテキストの最初の行を結合して表示。
6.  ペーストされるテキストの2行目以降を、それぞれ新しい `<div class="line">` として現在の行の直後に挿入。
7.  最後に、ペーストされた最終行に、元のカーソル位置以降のテキストを追記。
8.  カーソル位置を、ペーストされた内容の末尾に正確に再設定。

### 結果

この修正により、複数行をペーストしても `<div class="line">` がネストすることはなくなり、各行が正しく独立した要素として挿入されるようになった。これにより、保存時のテキスト重複問題も解消され、期待通りの動作が実現できた。